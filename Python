import fitz  # PyMuPDF
import re

pdf_path = "pdfextract.pdf"
doc = fitz.open(pdf_path)

# Load pages 15–30 (index 14–29), remove page number footer lines
pages = []
for page_number in range(14, min(30, len(doc))):
    visible_page_number = page_number + 1  # footer shows this number
    page_lines = doc[page_number].get_text().split('\n')

    # Remove footer line if it matches the visible page number
    filtered_lines = [
        line for line in page_lines if line.strip() != str(visible_page_number)
    ]

    pages.append((visible_page_number, filtered_lines))

doc.close()

# Regex patterns
section_start_pattern = re.compile(r'^\d+(\.\d+)*\s')
isa_pattern = re.compile(r'ISA\s\|\s\d+')

results = []

for page_num, lines in pages:
    i = 0
    while i < len(lines):
        line = lines[i].strip()
        if section_start_pattern.match(line):
            # Combine multi-line section header
            combined_line = line
            j = i + 1
            while j < len(lines):
                next_line = lines[j].strip()
                combined_line += ' ' + next_line
                if '[ISA' in next_line:
                    break
                j += 1
            combined_line = combined_line.strip()

            if len(combined_line) < 150 and isa_pattern.search(combined_line):
                k = j + 1
                what_ans, why_ans, execute_ans = [], [], []
                mode = None

                while k < len(lines):
                    current = lines[k].strip()
                    if section_start_pattern.match(current):
                        break
                    if current.lower().startswith("what do we do?"):
                        mode = "what"
                    elif current.lower().startswith("why do we do this?"):
                        mode = "why"
                    elif current.lower().startswith("execute the audit"):
                        mode = "execute"
                    elif mode == "what":
                        what_ans.append(current)
                    elif mode == "why":
                        why_ans.append(current)
                    elif mode == "execute":
                        execute_ans.append(current)
                    k += 1

                results.append({
                    "page": page_num,
                    "section": combined_line,
                    "what_do_we_do": ' '.join(what_ans).strip(),
                    "why_do_we_do_this": ' '.join(why_ans).strip(),
                    "execute_the_audit": ' '.join(execute_ans).strip()
                })
            i = j
        else:
            i += 1

# Print results
for item in results:
    print(f"[Page {item['page']}] {item['section']}")
    print(f"What do we do? -> {item['what_do_we_do']}")
    print(f"Why do we do this? -> {item['why_do_we_do_this']}")
    print(f"Execute the Audit -> {item['execute_the_audit']}\n")
