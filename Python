import pdfplumber
import re

pdf_path = r"C:\path\to\your\file.pdf"

# Step 1: Load and flatten all lines from all pages
document_lines = []  # list of (line_text, page_number)

with pdfplumber.open(pdf_path) as pdf:
    for page_index, page in enumerate(pdf.pages, start=1):
        text = page.extract_text()
        if not text:
            continue
        lines = text.splitlines()
        for line in lines:
            document_lines.append((line.strip(), page_index))

# Step 2: Detect all trigger points and collect section headers after each one
i = 0
while i < len(document_lines):
    line, page = document_lines[i]

    match_found = False

    # Case 1: trigger in single line
    if "How do we comply with the Standards?" in line and "[ISA | KAEGHDWC]" in line:
        match_found = True
        i += 1

    # Case 2: trigger split across two lines
    elif i + 1 < len(document_lines):
        next_line, _ = document_lines[i + 1]
        combined = line + " " + next_line
        if "How do we comply with the Standards?" in combined and "[ISA | KAEGHDWC]" in combined:
            match_found = True
            i += 2
        else:
            i += 1
    else:
        i += 1

    if match_found:
        print(f"\n[Page {page}] Trigger matched — start collecting section headers")

        # Start collecting section headers until the next trigger
        while i < len(document_lines):
            line, page = document_lines[i]

            # Stop if next trigger is found
            if "How do we comply with the Standards?" in line and "[ISA | KAEGHDWC]" in line:
                break
            elif (
                i + 1 < len(document_lines)
                and "How do we comply with the Standards?" in line + " " + document_lines[i + 1][0]
                and "[ISA | KAEGHDWC]" in line + " " + document_lines[i + 1][0]
            ):
                break

            # Detect section start (e.g., 1, 1.1, 1.2.3)
            if re.match(r"^\d+(\.\d+)*\b", line):
                section_lines = [line]
                i += 1
                # Keep appending until we reach a line that ends with ] (assume end of section title)
                while i < len(document_lines):
                    next_line, _ = document_lines[i]
                    section_lines.append(next_line)
                    if re.search(r"ISA\s*\|\s*\d+$", next_line):
                        break
                    i += 1

                section_title = ' '.join(section_lines).strip()
                if re.match(r"^\d+(\.\d+)*\s+.*ISA\s*\|\s*\d+$", section_title):
                    print(f"[Page {page}] Section Title: {section_title}")
                i += 1  # move to next line after section
            else:
                i += 1  # keep scanning
