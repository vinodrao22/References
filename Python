import pdfplumber
import re

pdf_path = r"C:\path\to\your\file.pdf"
results = []

with pdfplumber.open(pdf_path) as pdf:
    page = pdf.pages[15]  # Page 16
    text = page.extract_text()

    if not text:
        print("No text found.")
    else:
        lines = text.splitlines()
        i = 0

        while i < len(lines):
            line = lines[i].strip()
            section = None

            # Match lines starting with 1, 1.1, 1.1.1, etc.
            if re.match(r"^\d+(\.\d+)*\b", line):
                section = line

                # Add continuation lines if needed to get full section title
                if i + 1 < len(lines) and "[ISA |" in lines[i + 1]:
                    section += " " + lines[i + 1].strip()
                    i += 1
                elif i + 2 < len(lines) and "[ISA |" in lines[i + 2]:
                    section += " " + lines[i + 1].strip() + " " + lines[i + 2].strip()
                    i += 2

            else:
                i += 1
                continue

            # Look for Q&A block
            what, why, execute = "", "", ""
            i += 1

            if i < len(lines) and lines[i].strip().startswith("What do we do"):
                i += 1
                while i < len(lines) and not lines[i].strip().startswith("Why do we do this"):
                    what += " " + lines[i].strip()
                    i += 1

                if i < len(lines) and lines[i].strip().startswith("Why do we do this"):
                    i += 1
                    while i < len(lines) and not lines[i].strip().startswith("Execute the Audit"):
                        why += " " + lines[i].strip()
                        i += 1

                    if i < len(lines) and lines[i].strip().startswith("Execute the Audit"):
                        i += 1
                        while i < len(lines):
                            next_line = lines[i].strip()
                            # Stop at next section start
                            if re.match(r"^\d+(\.\d+)*\b", next_line):
                                break
                            if "[ISA |" in next_line:
                                break
                            execute += " " + next_line
                            i += 1

                        # Only save complete blocks
                        results.append({
                            "Section": section.strip(),
                            "What do we do?": what.strip(),
                            "Why do we do this?": why.strip(),
                            "Execute the Audit": execute.strip()
                        })
            else:
                i += 1

# Print results
for idx, item in enumerate(results, 1):
    print(f"\nSection {idx}")
    for key, value in item.items():
        print(f"{key}: {value}")
